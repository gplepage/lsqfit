<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Case Study: Outliers and Bayesian Integrals &#8212; lsqfit 13.3.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=4848ba22" />
    <link rel="stylesheet" type="text/css" href="_static/pyramid.css?v=310c80ee" />
    <script src="_static/documentation_options.js?v=d9bf959d"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="lsqfit - Nonlinear Least Squares Fitting" href="lsqfit.html" />
    <link rel="prev" title="Case Study: Fitting a Spline" href="case-spline.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="lsqfit.html" title="lsqfit - Nonlinear Least Squares Fitting"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="case-spline.html" title="Case Study: Fitting a Spline"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">lsqfit 13.3.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Case Study: Outliers and Bayesian Integrals</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="case-study-outliers-and-bayesian-integrals">
<span id="outliers"></span><h1>Case Study: Outliers and Bayesian Integrals<a class="headerlink" href="#case-study-outliers-and-bayesian-integrals" title="Link to this heading">¶</a></h1>
<p>In this case study, we analyze a fit with outliers in the data that
distort the least-squares solution. We show one approach to dealing with
the outliers that requires using Bayesian integrals
in place of least-squares fitting,
to fit the data while also modeling the outliers.</p>
<p>This case study is adapted from an example by Jake Vanderplas
on his <a class="reference external" href="http://jakevdp.github.io/blog/2014/06/06/frequentism-and-bayesianism-2-when-results-differ">Python blog</a>.
It is also discussed in the documentation for the <code class="xref py py-mod docutils literal notranslate"><span class="pre">vegas</span></code> module.</p>
<section id="the-problem">
<h2>The Problem<a class="headerlink" href="#the-problem" title="Link to this heading">¶</a></h2>
<p>We want to extrapolate a set of data values <code class="docutils literal notranslate"><span class="pre">y</span></code> to <code class="docutils literal notranslate"><span class="pre">x=0</span></code> fitting
a linear fit function (<code class="docutils literal notranslate"><span class="pre">fitfcn(x,p)</span></code>) to the data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">gvar</span> <span class="k">as</span> <span class="nn">gv</span>
<span class="kn">import</span> <span class="nn">lsqfit</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># least-squares fit to the data</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span>
        <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span>
        <span class="mf">2.2</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">,</span> <span class="mf">2.6</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span>
        <span class="mf">3.2</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.8</span>
        <span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">gvar</span><span class="p">([</span>
        <span class="s1">&#39;0.38(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;2.89(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;0.85(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;0.59(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;2.88(20)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;1.44(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;0.73(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;1.23(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;1.68(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;1.36(20)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;1.51(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;1.73(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;2.16(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;1.85(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;2.00(20)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;2.11(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;2.75(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;0.86(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;2.73(20)&#39;</span>
        <span class="p">])</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">lsqfit</span><span class="o">.</span><span class="n">nonlinear_fit</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">prior</span><span class="o">=</span><span class="n">make_prior</span><span class="p">(),</span> <span class="n">fcn</span><span class="o">=</span><span class="n">fitfcn</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fitfcn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">make_prior</span><span class="p">():</span>
    <span class="n">prior</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">BufferDict</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">gv</span><span class="o">.</span><span class="n">gvar</span><span class="p">([</span><span class="s1">&#39;0(5)&#39;</span><span class="p">,</span> <span class="s1">&#39;0(5)&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">prior</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>The fit is not good, with a <code class="docutils literal notranslate"><span class="pre">chi**2</span></code> per degree of freedom that is
much larger than one, despite rather broad priors for the intercept and
slope:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Least Squares Fit:
  chi2/dof [dof] = 13 [19]    Q = 1.2e-40    logGBF = -117.45

Parameters:
            c 0   1.149 (95)     [    0 ± 5.0 ]  
              1   0.261 (42)     [    0 ± 5.0 ]  

Settings:
  svdcut/n = 1e-12/0    tol = (1e-08*,1e-10,1e-10)    (itns/time = 5/0.1s)

</pre></div>
</div>
<p>The problem is evident if we plot the data:</p>
<a class="reference internal image-reference" href="_images/case-outliers1.png"><img alt="_images/case-outliers1.png" src="_images/case-outliers1.png" style="width: 60%;" /></a>
<p>At least three of the data points are outliers: they disagree with other
nearby points by several standard deviations. These outliers have a big
impact on the fit (dashed line). In particular they pull the <code class="docutils literal notranslate"><span class="pre">x=0</span></code> intercept (<code class="docutils literal notranslate"><span class="pre">fit.p['c'][0]</span></code>)
up above one, while the rest of the data suggest an intercept of 0.5
or less.</p>
</section>
<section id="a-solution">
<h2>A Solution<a class="headerlink" href="#a-solution" title="Link to this heading">¶</a></h2>
<p>There are many <em>ad hoc</em> prescriptions for handling outliers. In the best
of situations one would have an explanation for the outliers and seek
to model them accordingly. For example,
we might know that some fraction <code class="docutils literal notranslate"><span class="pre">w</span></code> of the time our detector
malfunctions, resulting in much larger measurement errors than usual.
This model can be represented by a more complicated probability
density function (PDF) for the data that consists of a linear combination
of the normal PDF with another PDF that is similar but with much larger
errors. The relative weights assigned to these two terms would be <code class="docutils literal notranslate"><span class="pre">1-w</span></code>
and <code class="docutils literal notranslate"><span class="pre">w</span></code>, respectively.</p>
<p>A modified data prior of this sort is incompatible with the least-squares
code in <a class="reference internal" href="lsqfit.html#module-lsqfit" title="lsqfit: Nonlinear least squares fitting."><code class="xref py py-mod docutils literal notranslate"><span class="pre">lsqfit</span></code></a>. Here we will incorporate it by replacing the
least-squares analysis with a Bayesian integral, where the normal PDF is
replaced by a modified PDF of the sort described above.
The complete code for this analysis is
as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">gvar</span> <span class="k">as</span> <span class="nn">gv</span>
<span class="kn">import</span> <span class="nn">lsqfit</span>
<span class="kn">import</span> <span class="nn">vegas</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1">### 1) least-squares fit to the data</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span>
        <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mf">1.8</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span>
        <span class="mf">2.2</span><span class="p">,</span> <span class="mf">2.4</span><span class="p">,</span> <span class="mf">2.6</span><span class="p">,</span> <span class="mf">2.8</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span>
        <span class="mf">3.2</span><span class="p">,</span> <span class="mf">3.4</span><span class="p">,</span> <span class="mf">3.6</span><span class="p">,</span> <span class="mf">3.8</span>
        <span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">gvar</span><span class="p">([</span>
        <span class="s1">&#39;0.38(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;2.89(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;0.85(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;0.59(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;2.88(20)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;1.44(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;0.73(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;1.23(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;1.68(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;1.36(20)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;1.51(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;1.73(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;2.16(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;1.85(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;2.00(20)&#39;</span><span class="p">,</span>
        <span class="s1">&#39;2.11(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;2.75(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;0.86(20)&#39;</span><span class="p">,</span> <span class="s1">&#39;2.73(20)&#39;</span>
        <span class="p">])</span>
    <span class="n">prior</span> <span class="o">=</span> <span class="n">make_prior</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;nonlinear_fit&#39;</span><span class="p">)</span>
    <span class="n">fit</span> <span class="o">=</span> <span class="n">lsqfit</span><span class="o">.</span><span class="n">nonlinear_fit</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">prior</span><span class="o">=</span><span class="n">prior</span><span class="p">,</span> <span class="n">fcn</span><span class="o">=</span><span class="n">fitfcn</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>

    <span class="c1">### 2) Bayesian integrals with modified PDF</span>
    <span class="nb">print</span><span class="p">(</span><span class="mi">20</span> <span class="o">*</span> <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;Bayesian integral fit&#39;</span><span class="p">)</span>
    <span class="n">modpdf</span> <span class="o">=</span> <span class="n">ModifiedPDF</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">fitfcn</span><span class="o">=</span><span class="n">fitfcn</span><span class="p">,</span> <span class="n">prior</span><span class="o">=</span><span class="n">prior</span><span class="p">)</span>

    <span class="c1"># integrator for expectation values with modified PDF</span>
    <span class="n">modpdf_ev</span> <span class="o">=</span> <span class="n">vegas</span><span class="o">.</span><span class="n">PDFIntegrator</span><span class="p">(</span><span class="n">param</span><span class="o">=</span><span class="n">fit</span><span class="o">.</span><span class="n">p</span><span class="p">,</span> <span class="n">pdf</span><span class="o">=</span><span class="n">modpdf</span><span class="p">)</span>

    <span class="c1"># adapt integrator to pdf</span>
    <span class="n">modpdf_ev</span><span class="p">(</span><span class="n">neval</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> <span class="n">nitn</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># calculate means and covariances of g(p)</span>
    <span class="nd">@vegas</span><span class="o">.</span><span class="n">rbatchintegrand</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">]}</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">modpdf_ev</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="c1"># print out results</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c =&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;corr(c) =&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">gv</span><span class="o">.</span><span class="n">evalcorr</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;b =&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;w =&#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">],</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;logBF =&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pdfnorm</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">fitfcn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">make_prior</span><span class="p">():</span>
    <span class="n">prior</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">BufferDict</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">gv</span><span class="o">.</span><span class="n">gvar</span><span class="p">([</span><span class="s1">&#39;0(5)&#39;</span><span class="p">,</span> <span class="s1">&#39;0(5)&#39;</span><span class="p">]))</span>
    <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;gb(b)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">BufferDict</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="s1">&#39;gb&#39;</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">)</span>
    <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;gw(w)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">BufferDict</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="s1">&#39;gw&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prior</span>

<span class="nd">@vegas</span><span class="o">.</span><span class="n">rbatchintegrand</span>
<span class="k">class</span> <span class="nc">ModifiedPDF</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Modified PDF to account for measurement failure. &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fitfcn</span><span class="p">,</span> <span class="n">prior</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitfcn</span> <span class="o">=</span> <span class="n">fitfcn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prior_pdf</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">PDF</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;rbatch&#39;</span><span class="p">)</span>
        <span class="c1"># add rbatch index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ymean</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yvar</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">y</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>

        <span class="c1"># modified PDF for data</span>
        <span class="n">fxp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fitfcn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="n">chi2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ymean</span> <span class="o">-</span> <span class="n">fxp</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">yvar</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">yvar</span><span class="p">)</span>
        <span class="n">y_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">chi2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span>
        <span class="n">yb_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">chi2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">norm</span><span class="p">)</span>
        <span class="c1"># product over probabilities for each y[i]</span>
        <span class="n">data_pdf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">w</span><span class="p">)</span> <span class="o">*</span> <span class="n">y_pdf</span> <span class="o">+</span> <span class="n">w</span> <span class="o">*</span> <span class="n">yb_pdf</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># multiply by prior PDF</span>
        <span class="k">return</span> <span class="n">data_pdf</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">prior_pdf</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Here class <code class="docutils literal notranslate"><span class="pre">ModifiedPDF</span></code> implements the modified PDF.  As usual the PDF for
the parameters (in <code class="docutils literal notranslate"><span class="pre">__call__</span></code>) is the product of a PDF for the data times a
PDF for the priors. The data PDF is the product of the PDFs for each data point,
but the latter PDFs are more complicated than usual as
they consists of two Gaussian distributions: one with the
nominal data errors (<code class="docutils literal notranslate"><span class="pre">y_pdf</span></code>), and the other with errors that are <code class="docutils literal notranslate"><span class="pre">b</span></code> times
times larger (<code class="docutils literal notranslate"><span class="pre">yb_pdf</span></code>). The prior’s PDF is Gaussian and here is implemented
use <code class="docutils literal notranslate"><span class="pre">gvar.PDF</span></code>. Parameter <code class="docutils literal notranslate"><span class="pre">w</span></code> determines the relative weight of each data PDF.</p>
<p><code class="docutils literal notranslate"><span class="pre">ModifiedPDF</span></code> is designed to handle integration points in batches
(<code class="docutils literal notranslate"><span class="pre">&#64;vegas.rbatchintegrand</span></code>): the parameters <code class="docutils literal notranslate"><span class="pre">p[k]</span></code> have an extra
index on the right labeling the integration point (e.g., <code class="docutils literal notranslate"><span class="pre">p['b'][i]</span></code>
and <code class="docutils literal notranslate"><span class="pre">p['c'][d,i]</span> <span class="pre">where</span> <span class="pre">``i</span></code> is the batch index).
This makes for substantially faster integrals.</p>
<p>The Bayesian integrals are estimated using <code class="xref py py-class docutils literal notranslate"><span class="pre">vegas.PDFIntegrator</span></code>
<code class="docutils literal notranslate"><span class="pre">modpdf_ev</span></code>, which is created from the least-squares fit output (<code class="docutils literal notranslate"><span class="pre">fit</span></code>).
It is used to evaluate expectation values of arbitrary functions of the
fit variables with respect to a modified PDF <code class="docutils literal notranslate"><span class="pre">modpdf</span></code> (an instance
of class <code class="docutils literal notranslate"><span class="pre">ModifiedPDF</span></code>).</p>
<p>We have modified <code class="docutils literal notranslate"><span class="pre">make_prior()</span></code> to introduce <code class="docutils literal notranslate"><span class="pre">w</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>
as new fit
parameters. The prior for <code class="docutils literal notranslate"><span class="pre">w</span></code> is uniformly distributed
across the interval from 0 to 1, while <code class="docutils literal notranslate"><span class="pre">b</span></code>’s prior is
uniformly distributed between 5 and 20. Parameters <code class="docutils literal notranslate"><span class="pre">w</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> play
no role in the initial least-squares fit. (The uniform distributions are implemented
by introducing functions <code class="docutils literal notranslate"><span class="pre">gw(w)</span></code> and <code class="docutils literal notranslate"><span class="pre">gb(b)</span></code> that map them onto Gaussian
distributions 0 ± 1. The integration parameters in the
Bayesian integrals are <code class="docutils literal notranslate"><span class="pre">gw(w)</span></code> and <code class="docutils literal notranslate"><span class="pre">gb(b)</span></code> but the <code class="docutils literal notranslate"><span class="pre">BufferDict</span></code> dictionary
makes the corresponding values of <code class="docutils literal notranslate"><span class="pre">w</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> available automatically.)</p>
<p>We first call <code class="docutils literal notranslate"><span class="pre">modpdf_ev</span></code> with no function, to allow the integrator to adapt
to the modified PDF. We then use <code class="docutils literal notranslate"><span class="pre">modpdf_ev.stats(f)</span></code> to calculate the
means, standard deviations, and covariances of the fit parameters in the
dictionary returned by
function <code class="docutils literal notranslate"><span class="pre">f(p)</span></code>. The output dictionary <code class="docutils literal notranslate"><span class="pre">s</span></code>
contains expectation values (<code class="xref py py-class docutils literal notranslate"><span class="pre">gvar.GVar</span></code>s) for the corresponding entries in <code class="docutils literal notranslate"><span class="pre">f(p)</span></code>.</p>
<p>The results from this code are as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>-------------------- nonlinear_fit
Least Squares Fit:
  chi2/dof [dof] = 13 [19]    Q = 1.2e-40    logGBF = -117.45

Parameters:
            c 0          1.149 (95)        [    0 ± 5.0 ]  
              1          0.261 (42)        [    0 ± 5.0 ]  
          gb(b)   8.33405e-15 ± 1.0        [    0 ± 1.0 ]  
          gw(w)   8.33405e-15 ± 1.0        [    0 ± 1.0 ]  
---------------------------------------------------------
              b          12.5 (6.0)        [ 12.5 (6.0) ]  
              w           0.50 (40)        [  0.50 (40) ]  

Settings:
  svdcut/n = 1e-12/0    tol = (1e-08*,1e-10,1e-10)    (itns/time = 5/0.1s)

-------------------- Bayesian integral fit
itn   integral        average         chi2/dof        Q
-------------------------------------------------------
  1   4.599(31)e-11   4.599(31)e-11       0.00     1.00
  2   4.542(32)e-11   4.571(23)e-11       0.80     0.68
  3   4.447(33)e-11   4.530(19)e-11       1.49     0.04
  4   4.518(32)e-11   4.527(16)e-11       1.38     0.04
  5   4.515(32)e-11   4.524(14)e-11       1.21     0.12
  6   4.561(34)e-11   4.530(13)e-11       1.13     0.21
  7   4.571(32)e-11   4.536(12)e-11       1.04     0.37
  8   4.518(37)e-11   4.534(12)e-11       0.98     0.55
  9   4.543(33)e-11   4.535(11)e-11       0.95     0.64
 10   4.533(32)e-11   4.535(10)e-11       0.94     0.67

c = [0.29(14) 0.619(60)]
corr(c) = [[ 1.         -0.90215491]
           [-0.90215491  1.        ]] 

b = 10.6(3.6)
w = 0.27(12) 

logBF = -23.8167(23)
</pre></div>
</div>
<p>The table after the fit shows results for the normalization of the
modified PDF from each of <code class="docutils literal notranslate"><span class="pre">nitn=10</span></code> iterations of the <code class="xref py py-mod docutils literal notranslate"><span class="pre">vegas</span></code>
algorithm used to estimate the integrals. The logarithm of the normalization
(<code class="docutils literal notranslate"><span class="pre">logBF</span></code>) is -23.8, which is much larger than the value -117.5 of <code class="docutils literal notranslate"><span class="pre">logGBF</span></code>
from the least-squares fit. This means that the data much prefer the
modified PDF (by a factor of <code class="docutils literal notranslate"><span class="pre">exp(-23.8</span> <span class="pre">+</span> <span class="pre">117.4)</span></code> or about 10<sup>40</sup>).</p>
<p>The new fit parameters are much more reasonable. In particular the
intercept is 0.29(14) rather than the 1.15(10) from the least-squares fit.
This is much better suited to the data (see the dashed line in red, with
the red band showing the 1-sigma region about the best fit):</p>
<a class="reference internal image-reference" href="_images/case-outliers2.png"><img alt="_images/case-outliers2.png" src="_images/case-outliers2.png" style="width: 60%;" /></a>
<p>Note, from the correlation matrix, that the intercept and slope are
anti-correlated, as one might guess for this fit.
The analysis also gives us an estimate for the failure rate <code class="docutils literal notranslate"><span class="pre">w=0.27(12)</span></code>
of our detectors (they fail about a quarter of the time) and the
extent <code class="docutils literal notranslate"><span class="pre">b=11(4)</span></code> of the failure (errors are about 11 times larger).</p>
</section>
<section id="a-variation">
<h2>A Variation<a class="headerlink" href="#a-variation" title="Link to this heading">¶</a></h2>
<p>A slightly different model for the failure that
leads to outliers assigns a different <code class="docutils literal notranslate"><span class="pre">w</span></code> to each data point.
It is easily implemented here by changing the prior
so that <code class="docutils literal notranslate"><span class="pre">w</span></code> is an array:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_prior</span><span class="p">():</span>
    <span class="n">prior</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">BufferDict</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">gv</span><span class="o">.</span><span class="n">gvar</span><span class="p">([</span><span class="s1">&#39;0(5)&#39;</span><span class="p">,</span> <span class="s1">&#39;0(5)&#39;</span><span class="p">]))</span>
    <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;gb(b)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">BufferDict</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="s1">&#39;gb&#39;</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">)</span>
    <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;gw(w)&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gv</span><span class="o">.</span><span class="n">BufferDict</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="s1">&#39;gw&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">19</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prior</span>
</pre></div>
</div>
<p>The Bayesian integral then has 22 parameters, rather than the 4 parameters
before. The code still takes only a few seconds to run (on a 2020 laptop).</p>
<p>The final results are quite similar to the other model:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.31</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="mf">0.608</span><span class="p">(</span><span class="mi">71</span><span class="p">)]</span>
<span class="n">corr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">=</span> <span class="p">[[</span> <span class="mf">1.</span>         <span class="o">-</span><span class="mf">0.90853691</span><span class="p">]</span>
           <span class="p">[</span><span class="o">-</span><span class="mf">0.90853691</span>  <span class="mf">1.</span>        <span class="p">]]</span> 

<span class="n">b</span> <span class="o">=</span> <span class="mf">8.8</span><span class="p">(</span><span class="mf">3.1</span><span class="p">)</span>
<span class="n">w</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.37</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="mf">0.66</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span> <span class="mf">0.39</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="mf">0.41</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="mf">0.66</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="mf">0.50</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span> <span class="mf">0.54</span><span class="p">(</span><span class="mi">29</span><span class="p">)</span> <span class="mf">0.36</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span>
 <span class="mf">0.43</span><span class="p">(</span><span class="mi">29</span><span class="p">)</span> <span class="mf">0.40</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span> <span class="mf">0.40</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="mf">0.35</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span> <span class="mf">0.42</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span> <span class="mf">0.38</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span> <span class="mf">0.39</span><span class="p">(</span><span class="mi">26</span><span class="p">)</span> <span class="mf">0.39</span><span class="p">(</span><span class="mi">27</span><span class="p">)</span>
 <span class="mf">0.48</span><span class="p">(</span><span class="mi">29</span><span class="p">)</span> <span class="mf">0.68</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span> <span class="mf">0.36</span><span class="p">(</span><span class="mi">27</span><span class="p">)]</span> 

<span class="n">logBF</span> <span class="o">=</span> <span class="o">-</span><span class="mf">24.379</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span>
</pre></div>
</div>
<p>Note that the logarithm of the Bayes Factor <code class="docutils literal notranslate"><span class="pre">logBF</span></code> is slightly lower for
this model than before. It is also less accurately determined (18x), because
22-parameter integrals are considerably more difficult than 4-parameter
integrals. More precision can be obtained by increasing <code class="docutils literal notranslate"><span class="pre">neval</span></code>, but
the current precision is more than adequate.</p>
<p>Only three of the <code class="docutils literal notranslate"><span class="pre">w[i]</span></code> values listed in the output are more than two
standard deviations away from zero. Not surprisingly, these correspond to
the unambiguous outliers.</p>
<p>The outliers in this case are pretty obvious; one is tempted to simply drop
them. It is clearly better, however, to understand why they have occurred and
to quantify the effect if possible, as above. Dropping outliers would be much
more difficult if they were, say, three times closer to the rest of the data.
The least-squares fit would still be poor (<code class="docutils literal notranslate"><span class="pre">chi**2</span></code> per degree of freedom of
3) and its intercept a bit too high (0.6(1)). Using the modified PDF, on the
other hand, would give results very similar to what we obtained above: for
example, the intercept would be 0.35(17).</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">Case Study: Outliers and Bayesian Integrals</a><ul>
<li><a class="reference internal" href="#the-problem">The Problem</a></li>
<li><a class="reference internal" href="#a-solution">A Solution</a></li>
<li><a class="reference internal" href="#a-variation">A Variation</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="case-spline.html"
                          title="previous chapter">Case Study: Fitting a Spline</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="lsqfit.html"
                          title="next chapter"><code class="xref py py-mod docutils literal notranslate"><span class="pre">lsqfit</span></code> - Nonlinear Least Squares Fitting</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/case-outliers.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="lsqfit.html" title="lsqfit - Nonlinear Least Squares Fitting"
             >next</a> |</li>
        <li class="right" >
          <a href="case-spline.html" title="Case Study: Fitting a Spline"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">lsqfit 13.3.1 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Case Study: Outliers and Bayesian Integrals</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2009-2023, G. P. Lepage.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    </div>
  </body>
</html>